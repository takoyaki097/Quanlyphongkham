<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>YHCT Pro - Qu·∫£n l√Ω Ph√≤ng Kh√°m</title>
    <!-- CSS Reset & Base -->
    <link rel="stylesheet" href="style.css">
    
    <!-- C√ÅC TH∆Ø VI·ªÜN C·∫¶N THI·∫æT -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <!-- TH∆Ø VI·ªÜN LOCALFORAGE -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif:ital,wght@0,400;0,700;1,400&family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- CSS M·ªöI: GIAO DI·ªÜN TH·∫∫ THU·ªêC/TH·ª¶ THU·∫¨T L·ªöN --- */
        
        /* Container ch√≠nh cho m·ªói d√≤ng thu·ªëc/th·ªß thu·∫≠t */
        .med-row-grid {
            display: grid;
            /* Chia l√†m 3 c·ªôt ƒë·ªÅu nhau cho c√°c √¥ nh·∫≠p s·ªë */
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 10px;
            padding: 12px;
            background: #fff;
            border: 1px solid #d7ccc8;
            border-radius: 16px; /* Bo g√≥c tr√≤n h∆°n */
            margin-bottom: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: relative;
        }

        /* D√≤ng t√™n thu·ªëc/th·ªß thu·∫≠t: Lu√¥n n·∫±m tr√™n c√πng, chi·∫øm h·∫øt chi·ªÅu ngang */
        .med-row-name {
            grid-column: 1 / -1;
            margin-bottom: 5px;
            padding-right: 35px; /* Ch·ª´a ch·ªó cho n√∫t x√≥a */
        }
        
        .med-row-name input, .med-row-name div {
            font-size: 16px;
            font-weight: 700;
            color: #3e2723;
            width: 100%;
            border: none;
            border-bottom: 1px dashed #bdbdbd;
            padding: 5px 0;
            background: transparent;
            outline: none;
        }

        /* N√∫t x√≥a (X) n·∫±m g√≥c tr√™n ph·∫£i */
        .med-delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ef5350;
            font-size: 20px;
            font-weight: bold;
            background: #ffebee;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            z-index: 10;
        }

        /* Nh√≥m Input (Label + √î nh·∫≠p) */
        .med-input-group {
            display: flex;
            flex-direction: column;
        }
        
        .med-input-group label {
            font-size: 10px;
            color: #8d6e63;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 4px;
            white-space: nowrap; /* Kh√¥ng xu·ªëng d√≤ng label */
        }

        /* √î nh·∫≠p li·ªáu S·ªê to, d·ªÖ b·∫•m */
        .med-input-large {
            height: 48px; /* K√≠ch th∆∞·ªõc l·ªõn chu·∫©n ng√≥n tay */
            width: 100%;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: #3e2723;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background-color: #fafafa;
            outline: none;
        }
        
        .med-input-large:focus {
            border-color: #8d6e63;
            background-color: #fff;
            box-shadow: 0 0 0 2px rgba(141, 110, 99, 0.2);
        }

        /* N√∫t gi·∫£m gi√° (d√†nh ri√™ng cho th·ªß thu·∫≠t) */
        .med-discount-btn {
            height: 48px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            color: #1976d2;
            border: 1px dashed #90caf9;
            border-radius: 10px;
            background: #e3f2fd;
        }

        /* --- THANH TR∆Ø·ª¢T NGANG CHO C√ÅC BU·ªîI (S√ÅNG/TR∆ØA/CHI·ªÄU/T·ªêI) --- */
        .med-usage-row {
            grid-column: 1 / -1; /* Chi·∫øm h·∫øt chi·ªÅu ngang */
            display: flex;
            gap: 8px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #eeeeee;
            
            /* K√≠ch ho·∫°t tr∆∞·ª£t ngang */
            overflow-x: auto; 
            white-space: nowrap;
            padding-bottom: 5px; /* Ch·ª´a ch·ªó cho thanh scroll n·∫øu c√≥ */
            -webkit-overflow-scrolling: touch; /* Tr∆∞·ª£t m∆∞·ª£t tr√™n iOS */
            scrollbar-width: none; /* ·∫®n thanh scroll tr√™n Firefox */
        }
        
        /* ·∫®n thanh scroll tr√™n Chrome/Safari/Edge */
        .med-usage-row::-webkit-scrollbar {
            display: none;
        }

        /* N√∫t ch·ªçn bu·ªïi (Vi√™n thu·ªëc) */
        .time-btn-large {
            flex: 0 0 auto; /* Kh√¥ng cho ph√©p co l·∫°i, gi·ªØ nguy√™n k√≠ch th∆∞·ªõc */
            min-width: 70px; /* ƒê·ªß r·ªông cho ch·ªØ */
            padding: 8px 16px;
            text-align: center;
            border-radius: 25px; /* Bo tr√≤n nh∆∞ vi√™n thu·ªëc */
            border: 1px solid #d7ccc8;
            background: #fff;
            color: #5d4037;
            font-size: 13px;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        .time-btn-large.active {
            background: #5d4037;
            color: white;
            border-color: #5d4037;
            box-shadow: 0 3px 6px rgba(93, 64, 55, 0.3);
            transform: translateY(-1px);
        }

        /* CSS M·ªöI CHO PH·∫¶N T·ªîNG GI√Å V√Ä GHI CH√ö */
        .rx-footer {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px dashed #d7ccc8;
            display: grid;
            grid-template-columns: 2fr 1fr; /* Ghi ch√∫ r·ªông g·∫•p ƒë√¥i gi√° */
            gap: 10px;
        }
        
        .rx-header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            background: #fdfbf7;
            padding: 10px;
            border-radius: 12px;
            border: 1px solid #efebe9;
        }

        /* CSS CHO B·ªò L·ªåC TH√ÅNG (MONTH FILTER CHIPS) */
        .month-chip {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
            color: #5d4037;
            background: #efebe9;
            border: 1px solid #d7ccc8;
            transition: all 0.2s;
            cursor: pointer;
        }

        .month-chip.active {
            background: #5d4037;
            color: white;
            border-color: #3e2723;
            box-shadow: 0 2px 5px rgba(93, 64, 55, 0.3);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body>

    <div class="max-w-3xl mx-auto">
        <!-- HEADER -->
        <div id="mainHeader">
            <div id="headerOverlay"></div>
            <div id="mainHeaderCard" class="header-card">
                <div>
                    <h1 id="displayTitle" class="text-2xl font-bold uppercase text-[#3e2723]">Ph√≤ng Kh√°m</h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="w-8 h-[2px] bg-[#8d6e63] header-sep"></span>
                        <p id="displayDoctor" class="serif italic text-sm text-[#5d4037]">ƒê√¥ng Y</p>
                    </div>
                </div>
                <!-- C·ªê ƒê·ªäNH K√çCH TH∆Ø·ªöC √î L·ª¢I NHU·∫¨N -->
                <div class="text-right cursor-pointer" onclick="window.handleProfitBoxClick()">
                    <p id="monthLabel" class="text-[9px] font-bold uppercase text-[#a1887f] mb-1">TH√ÅNG</p>
                    <div class="bg-[#fafafa] border border-[#eee] px-3 py-1 rounded-lg min-w-[140px] text-center shadow-sm">
                        <div id="profitLabel" class="font-mono font-bold text-[#3e2723] text-lg truncate">******</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MAIN MENU -->
        <div id="menuContainer" class="px-5 mt-6 pb-20">
            <div class="grid grid-cols-5 gap-3 mb-6">
                <button type="button" onclick="window.openPatientModal()" class="col-span-2 btn-glass py-4 uppercase text-xs text-[#3e2723]">+ B·ªánh nh√¢n</button>
                <button type="button" onclick="window.openStats()" class="col-span-2 btn-glass py-4 uppercase text-xs text-[#3e2723]">üìä B√°o c√°o</button>
                <button type="button" onclick="window.openSettings()" class="btn-glass text-xl text-[#5d4037]">‚öôÔ∏è</button>
            </div>
            
            <div class="relative mb-3">
                <input type="text" id="search" onkeyup="window.debouncedRender()" placeholder="üîç T√¨m t√™n ho·∫∑c s·ªë ƒëi·ªán tho·∫°i..." class="w-full bg-white border border-[#e0e0e0] rounded-xl py-3 px-4 shadow-sm text-[#3e2723] outline-none focus:border-[#8d6e63] ipad-input-fix">
            </div>

            <!-- K·∫æT C·∫§U M·ªöI: B·ªò L·ªåC TH√ÅNG (Horizontal Scroll) -->
            <div id="monthFilterArea" class="flex gap-2 overflow-x-auto pb-2 mb-2 no-scrollbar pl-1">
                <!-- Javascript s·∫Ω ƒëi·ªÅn c√°c n√∫t th√°ng v√†o ƒë√¢y -->
                <!-- V√≠ d·ª•: <button class="month-chip active">T1/2026</button> -->
            </div>
            
            <!-- DANH S√ÅCH B·ªÜNH NH√ÇN -->
            <div id="list" class="space-y-3 pb-24"></div>
        </div>
    </div>

    <!-- VISIT MODAL (KH√ÅM B·ªÜNH) -->
    <div id="vModal" class="modal">
        <div class="modal-box">
            <div class="modal-header">
                <h2 class="font-bold text-lg text-[#3e2723] truncate serif">Kh√°m: <span id="vPatientName"></span></h2>
                <button onclick="window.closeModals()" class="text-3xl text-gray-300 px-2">&times;</button>
            </div>
            
            <div class="tabs">
                <button class="tab-btn active" id="tab1" onclick="window.goToStep(1)">1. Ch·∫©n ƒëo√°n</button>
                <button class="tab-btn" id="tab2" onclick="window.goToStep(2)">2. T·ª© ch·∫©n</button>
                <button class="tab-btn" id="tab3" onclick="window.goToStep(3)">3. ƒêi·ªÅu tr·ªã</button>
                <button class="tab-btn" id="tab4" onclick="window.goToStep(4)">4. K·∫øt th√∫c</button>
            </div>
            
            <div class="modal-body" id="stepContainer">
                <input type="hidden" id="vPid"><input type="hidden" id="vVisitId">
                
                <!-- STEP 1: CH·∫®N ƒêO√ÅN -->
                <div id="step1" class="step-content active space-y-5">
                    <div><label class="song-label">Ng√†y kh√°m</label><input type="date" id="vDate" class="song-input ipad-input-fix"></div>
                    <div><label class="song-label">Ch·∫©n ƒëo√°n</label><select id="vDiseaseSelect" onchange="window.loadDiseaseSuggestions()" class="song-input mb-2 font-bold text-[#3e2723]"><option value="">-- Ch·ªçn b·ªánh m·∫´u --</option></select><input type="text" id="vDiseaseInput" placeholder="Ch·∫©n ƒëo√°n c·ª• th·ªÉ..." class="song-input ipad-input-fix"></div>
                    <div id="suggestedSymptomsBox" class="hidden p-3 bg-[#f1f8e9] border border-[#c5e1a5] rounded-lg"><label class="song-label text-[#33691e]">G·ª£i √Ω</label><div id="symptomButtons" class="flex flex-wrap gap-1 mt-1"></div></div>
                    <div><label class="song-label">Tri·ªáu ch·ª©ng & Ghi ch√∫</label><textarea id="vSpecial" rows="3" class="song-input ipad-input-fix"></textarea></div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="number-input-label">HUY·∫æT √ÅP (mmHg)</div>
                            <div class="grid grid-cols-2 gap-2">
                                <div class="number-input-container">
                                    <input type="text" id="vBpSys" class="number-input-display" placeholder="120" readonly onclick="window.openNumberPad('vBpSys', 'Huy·∫øt √°p t√¢m thu', '50-250', 120)" onfocus="this.blur()">
                                    <div class="text-center text-xs text-gray-500 mt-1">T√¢m thu</div>
                                </div>
                                <div class="number-input-container">
                                    <input type="text" id="vBpDia" class="number-input-display" placeholder="80" readonly onclick="window.openNumberPad('vBpDia', 'Huy·∫øt √°p t√¢m tr∆∞∆°ng', '30-150', 80)" onfocus="this.blur()">
                                    <div class="text-center text-xs text-gray-500 mt-1">T√¢m tr∆∞∆°ng</div>
                                </div>
                            </div>
                            <div class="text-center font-bold text-[#3e2723] mt-2" id="displayBP">120/80</div>
                        </div>
                        <div>
                            <div class="number-input-label">M·∫†CH (l·∫ßn/ph√∫t)</div>
                            <div class="number-input-container"><input type="text" id="vPulse" class="number-input-display" placeholder="80" readonly onclick="window.openNumberPad('vPulse', 'M·∫°ch', '40-180', 80)" onfocus="this.blur()"></div>
                            <div class="text-center font-bold text-[#3e2723] mt-2" id="displayPulse">80</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><div class="number-input-label">CHI·ªÄU CAO (cm)</div><div class="number-input-container"><input type="text" id="vHeight" class="number-input-display" placeholder="165" readonly onclick="window.openNumberPad('vHeight', 'Chi·ªÅu cao', '100-220', 165)" onfocus="this.blur()"></div></div>
                        <div><div class="number-input-label">C√ÇN N·∫∂NG (kg)</div><div class="number-input-container"><input type="text" id="vWeight" class="number-input-display" placeholder="60" readonly onclick="window.openNumberPad('vWeight', 'C√¢n n·∫∑ng', '30-150', 60)" onfocus="this.blur()"></div></div>
                    </div>
                    <div class="flex justify-between text-sm font-bold text-[#3e2723] mt-1"><span id="displayHeightWeight">165cm - 60kg</span><span id="displayBMI">BMI: 22.0</span></div>
                </div>

                <!-- STEP 2: T·ª® CH·∫®N -->
                <div id="step2" class="step-content hidden space-y-4">
                    <div class="tuchan-section"><div class="tuchan-title"><span>1</span> V·ªåNG (Nh√¨n)</div><div id="tuchanVongButtons" class="flex flex-wrap mb-2"></div><input type="text" id="vVongExtra" class="song-input border-0 border-b rounded-none px-0 ipad-input-fix" placeholder="Ghi ch√∫ th√™m..."></div>
                    <div class="tuchan-section"><div class="tuchan-title"><span>2</span> VƒÇN (Nghe, Ng·ª≠i)</div><div id="tuchanVanButtons" class="flex flex-wrap mb-2"></div><input type="text" id="vVanExtra" class="song-input border-0 border-b rounded-none px-0 ipad-input-fix" placeholder="Ghi ch√∫ th√™m..."></div>
                    <div class="tuchan-section"><div class="tuchan-title"><span>3</span> V·∫§N (H·ªèi)</div><div id="tuchanVanhoiButtons" class="flex flex-wrap mb-2"></div><input type="text" id="vVanHoiExtra" class="song-input border-0 border-b rounded-none px-0 ipad-input-fix" placeholder="Ghi ch√∫ th√™m..."></div>
                    <div class="tuchan-section"><div class="tuchan-title"><span>4</span> THI·∫æT (S·ªù n·∫Øn)</div><div id="tuchanThietButtons" class="flex flex-wrap mb-2"></div><input type="text" id="vThietExtra" class="song-input border-0 border-b rounded-none px-0 ipad-input-fix" placeholder="Ghi ch√∫ th√™m..."></div>
                    <div class="tuchan-section"><div class="tuchan-title"><span>5</span> THI·ªÜT (L∆∞·ª°i)</div><div id="tuchanThietchanButtons" class="flex flex-wrap mb-2"></div><input type="text" id="vThietChanExtra" class="song-input border-0 border-b rounded-none px-0 ipad-input-fix" placeholder="Ghi ch√∫ th√™m..."></div>
                    <div class="tuchan-section border-2 border-red-100 bg-red-50"><div class="tuchan-title"><span>6</span> M·∫†CH</div><div id="tuchanMachchanButtons" class="flex flex-wrap mb-2"></div><input type="text" id="vMachChanExtra" class="song-input bg-transparent border-0 border-b border-red-200 rounded-none px-0 ipad-input-fix" placeholder="M√¥ t·∫£ m·∫°ch..."></div>
                </div>

                <!-- STEP 3: ƒêI·ªÄU TR·ªä -->
                <div id="step3" class="step-content hidden space-y-6">
                    <!-- PROCEDURES SECTION -->
                    <div class="bg-white p-4 border border-[#d7ccc8] rounded-xl shadow-sm">
                        <div class="mb-3">
                            <label class="font-bold text-[#5d4037] serif text-lg block mb-2">Ch·ªâ ƒë·ªãnh Th·ªß thu·∫≠t</label>
                            
                            <!-- Khu v·ª±c hi·ªÉn th·ªã c√°c n√∫t ch·ªçn th·ªß thu·∫≠t -->
                            <div class="bg-[#fdfbf7] p-3 rounded-lg border border-dashed border-[#d7ccc8] mb-3">
                                <p class="text-[10px] uppercase font-bold text-[#8d6e63] mb-2">Ch·ªçn th·ªß thu·∫≠t c√≥ s·∫µn:</p>
                                <div id="vProcOptionsArea" class="flex flex-wrap gap-2">
                                    <span class="text-xs text-gray-400 italic">Ch∆∞a c√≥ th·ªß thu·∫≠t n√†o trong c√†i ƒë·∫∑t.</span>
                                </div>
                            </div>
                        </div>

                        <!-- Danh s√°ch th·ªß thu·∫≠t ƒë√£ ch·ªçn -->
                        <div class="border-t border-gray-100 pt-2">
                            <label class="text-xs font-bold text-[#3e2723] uppercase mb-2 block">Th·ªß thu·∫≠t ƒë√£ k√™:</label>
                            <div id="vProcList" class="space-y-3"></div>
                        </div>
                    </div>
                    
                    <!-- EASTERN MEDICINE SECTION -->
                    <div class="bg-white p-4 border border-[#d7ccc8] rounded-xl shadow-sm">
                        <!-- Header with Title and Global Days -->
                        <div class="rx-header-controls">
                            <div>
                                <label class="font-bold text-[#5d4037] serif text-lg block">ƒê√¥ng Y (Gam)</label>
                                <button onclick="window.addMedRow('east')" class="text-[10px] bg-[#5d4037] text-white px-3 py-1 rounded-full mt-1">+ V·ªã thu·ªëc</button>
                            </div>
                            <div class="flex flex-col items-center">
                                <label class="text-[10px] font-bold text-[#8d6e63] uppercase">S·ªë thang</label>
                                <input type="number" id="vEastDays" class="med-input-large" style="width: 80px; height: 40px; font-size: 16px;" value="1" onclick="window.openNumberPad('vEastDays', 'S·ªë thang thu·ªëc ƒê√¥ng Y', '1-100', 1)" readonly>
                            </div>
                        </div>

                        <div id="eastPresetsArea" class="mb-3 hidden p-2 bg-[#fdfbf7] rounded border border-dashed border-[#d7ccc8]">
                            <p class="text-[10px] uppercase font-bold text-[#8d6e63] mb-1">B√†i thu·ªëc m·∫´u:</p>
                            <div id="eastPresetButtons" class="whitespace-nowrap overflow-x-auto pb-1"></div>
                        </div>
                        
                        <div id="vMedListEast" class="space-y-2 max-h-60 overflow-y-auto pr-1"></div>

                        <!-- Footer: Note & Manual Price Override -->
                        <div class="rx-footer">
                            <div class="med-input-group">
                                <label>Ghi ch√∫ / C√°ch d√πng</label>
                                <textarea id="vEastNote" rows="1" class="w-full text-sm border-b border-gray-300 py-2 outline-none text-[#5d4037] bg-transparent ipad-input-fix" placeholder="C√°ch s·∫Øc, u·ªëng..."></textarea>
                            </div>
                            <div class="med-input-group">
                                <label>Gi√° tr·ªçn g√≥i</label>
                                <input type="number" id="vEastManualPrice" class="med-input-large" style="height: 40px; font-size: 14px;" placeholder="T·ª± t√≠nh..." onchange="window.calcTotal()">
                            </div>
                        </div>
                    </div>
                    
                    <!-- WESTERN MEDICINE SECTION -->
                    <div class="bg-white p-4 border border-blue-200 rounded-xl shadow-sm">
                        <!-- Header with Title and Global Days -->
                        <div class="rx-header-controls bg-blue-50 border-blue-100">
                            <div>
                                <label class="font-bold text-blue-800 serif text-lg block">T√¢y Y (Vi√™n)</label>
                                <button onclick="window.addMedRow('west')" class="text-[10px] bg-blue-600 text-white px-3 py-1 rounded-full mt-1">+ Thu·ªëc</button>
                            </div>
                            <div class="flex flex-col items-center">
                                <label class="text-[10px] font-bold text-blue-800 uppercase">S·ªë ng√†y</label>
                                <input type="number" id="vWestDays" class="med-input-large border-blue-200 text-blue-800" style="width: 80px; height: 40px; font-size: 16px;" value="1" onclick="window.openNumberPad('vWestDays', 'S·ªë ng√†y thu·ªëc T√¢y Y', '1-100', 1)" readonly>
                            </div>
                        </div>

                        <div id="vMedListWest" class="space-y-2"></div>

                        <!-- Footer: Note & Manual Price Override -->
                        <div class="rx-footer border-blue-200">
                            <div class="med-input-group">
                                <label class="text-blue-800">L·ªùi d·∫∑n / Ki√™ng k·ªµ</label>
                                <textarea id="vWestNote" rows="1" class="w-full text-sm border-b border-blue-200 py-2 outline-none text-blue-800 bg-transparent ipad-input-fix" placeholder="U·ªëng sau ƒÉn..."></textarea>
                            </div>
                            <div class="med-input-group">
                                <label class="text-blue-800">Gi√° tr·ªçn g√≥i</label>
                                <input type="number" id="vWestManualPrice" class="med-input-large border-blue-200 text-blue-800" style="height: 40px; font-size: 14px;" placeholder="T·ª± t√≠nh..." onchange="window.calcTotal()">
                            </div>
                        </div>
                    </div>
                    
                    <!-- TOTAL CALCULATION -->
                    <div class="bg-[#efebe9] p-4 rounded-xl border border-[#d7ccc8]">
                        <div class="flex justify-between text-sm mt-1">
                            <span>Ti·ªÅn thu·ªëc ƒê√¥ng Y:</span>
                            <span id="displayMedTotalEast" class="font-bold">0ƒë</span>
                        </div>
                        <div class="flex justify-between text-sm mt-1">
                            <span>Ti·ªÅn thu·ªëc T√¢y Y:</span>
                            <span id="displayMedTotalWest" class="font-bold">0ƒë</span>
                        </div>
                        <div class="flex justify-between text-sm mt-2">
                            <span>Th·ªß thu·∫≠t:</span>
                            <span id="displayProcTotal" class="font-bold">0ƒë</span>
                        </div>
                        <div class="flex justify-between text-xl font-black mt-3 pt-2 border-t border-[#a1887f] text-[#3e2723]">
                            <span>T·ªïng c·ªông:</span>
                            <span id="displayGrandTotal">0ƒë</span>
                        </div>
                        <div class="mt-2">
                            <label class="text-[10px] uppercase font-bold text-gray-500">V·ªën:</label>
                            <input type="number" id="vCost" class="song-input text-right py-1 h-8 ipad-input-fix" placeholder="0">
                        </div>
                    </div>
                </div>

                <!-- STEP 4: THANH TO√ÅN -->
                <div id="step4" class="step-content hidden space-y-6 text-center">
                    <div class="bg-[#fffcf7] p-8 rounded-2xl shadow-inner border border-[#d7ccc8]">
                        <h3 class="font-black text-4xl text-[#3e2723] mb-1" id="finalTotal">0ƒë</h3>
                        <p class="text-xs uppercase text-[#8d6e63] font-bold tracking-widest">T·ªîNG THANH TO√ÅN</p>
                        <div class="mt-6 flex flex-col items-center gap-2">
                            <label class="text-xs font-bold text-[#8d6e63]">Chi·∫øt kh·∫•u:</label>
                            <button onclick="window.openNumberPad('vDiscountPercent', 'Chi·∫øt kh·∫•u (%)', '0-100', 0)" class="discount-btn" id="discountBtn">0% ‚ñº</button>
                            <input type="hidden" id="vDiscountPercent" value="0">
                        </div>
                    </div>
                    
                    <div id="qrPaymentSection" class="hidden flex flex-col items-center p-4 border border-[#eee] rounded-xl bg-white">
                        <p class="text-xs font-bold uppercase text-[#5d4037] mb-2">Qu√©t m√£ thanh to√°n</p>
                        <img id="displayQrPayment" src="" class="w-48 h-48 object-contain border rounded-lg">
                    </div>

                    <div class="flex items-center justify-center gap-3 p-3 border rounded-xl">
                        <input type="checkbox" id="vPaid" class="w-5 h-5 accent-[#5d4037]" checked>
                        <label for="vPaid" class="font-bold text-[#3e2723]">ƒê√£ thu ti·ªÅn</label>
                    </div>
                    
                    <!-- PRINT OPTIONS -->
                    <div class="bg-white p-4 border rounded-xl">
                        <p class="text-xs font-bold uppercase text-[#5d4037] mb-2">T√πy ch·ªçn in ·∫•n</p>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="window.preparePrint('east')" class="print-option-btn">
                                <span class="text-lg">üåø</span>
                                <span class="text-xs font-bold mt-1">ƒê∆°n ƒê√¥ng Y</span>
                            </button>
                            <button onclick="window.preparePrint('west')" class="print-option-btn">
                                <span class="text-lg">üíä</span>
                                <span class="text-xs font-bold mt-1">ƒê∆°n T√¢y Y</span>
                            </button>
                            <button onclick="window.preparePrint('both')" class="print-option-btn">
                                <span class="text-lg">üìã</span>
                                <span class="text-xs font-bold mt-1">ƒê∆°n c·∫£ hai</span>
                            </button>
                            <button onclick="window.preparePrint('invoice')" class="print-option-btn">
                                <span class="text-lg">üßæ</span>
                                <span class="text-xs font-bold mt-1">H√≥a ƒë∆°n</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button onclick="window.prevStep()" id="btnBack" class="flex-1 py-3 btn-glass hidden">Quay l·∫°i</button>
                <button onclick="window.nextStep()" id="btnNext" class="flex-1 py-3 btn-primary uppercase shadow-lg">Ti·∫øp t·ª•c</button>
                <button onclick="window.saveOnly()" id="btnSaveOnly" class="flex-1 py-3 btn-glass text-[#5d4037] hidden font-bold border-2 border-[#d7ccc8]">L∆ØU</button>
                <button onclick="window.saveAndPrint()" id="btnPrint" class="flex-1 py-3 btn-primary bg-[#3e2723] hidden shadow-xl border-2 border-[#3e2723]">IN</button>
            </div>
        </div>
    </div>

    <!-- PRINT OPTIONS MODAL -->
    <div id="printModal" class="modal">
        <div class="modal-box max-w-md">
            <div class="modal-header">
                <h2 class="font-bold text-xl text-[#3e2723]">Ch·ªçn lo·∫°i in</h2>
                <button onclick="window.closeModals()" class="text-3xl text-gray-300 px-2">&times;</button>
            </div>
            <div class="modal-body p-6">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <button onclick="window.doPrint('east')" class="print-option-btn">
                        <span class="text-2xl">üåø</span>
                        <span class="text-sm font-bold mt-2">ƒê∆°n ƒê√¥ng Y</span>
                    </button>
                    <button onclick="window.doPrint('west')" class="print-option-btn">
                        <span class="text-2xl">üíä</span>
                        <span class="text-sm font-bold mt-2">ƒê∆°n T√¢y Y</span>
                    </button>
                    <button onclick="window.doPrint('both')" class="print-option-btn">
                        <span class="text-2xl">üìã</span>
                        <span class="text-sm font-bold mt-2">ƒê∆°n c·∫£ hai</span>
                    </button>
                    <button onclick="window.doPrint('invoice')" class="print-option-btn">
                        <span class="text-2xl">üßæ</span>
                        <span class="text-sm font-bold mt-2">H√≥a ƒë∆°n</span>
                    </button>
                </div>
                <div class="text-center">
                    <button onclick="window.closeModals()" class="btn-glass px-6 py-2">H·ªßy</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PATIENT MODAL -->
    <div id="pModal" class="modal"><div class="modal-box" style="height:auto; max-height:80vh;"><div class="modal-header"><h2 class="font-bold text-xl text-[#3e2723]">H·ªì S∆° B·ªánh Nh√¢n</h2><button onclick="window.closeModals()" class="text-3xl text-gray-300 px-2">&times;</button></div><div class="modal-body"><input type="hidden" id="pEditId"><div class="space-y-4"><div><label class="song-label">H·ªç T√™n *</label><input type="text" id="pName" class="song-input ipad-input-fix" placeholder="Nh·∫≠p h·ªç t√™n"></div><div class="grid grid-cols-2 gap-4"><div><label class="song-label">NƒÉm sinh</label><div class="number-input-container"><input type="text" id="pYear" class="number-input-display" placeholder="1990" readonly onclick="window.openNumberPad('pYear', 'NƒÉm sinh', '1900-2024', 1990)" onfocus="this.blur()"></div></div><div><label class="song-label">S·ªë ƒëi·ªán tho·∫°i</label><div class="number-input-container"><input type="text" id="pPhone" class="number-input-display" placeholder="0123456789" readonly onclick="window.openPhonePad()" onfocus="this.blur()"></div></div></div><div><label class="song-label">ƒê·ªãa ch·ªâ</label><input type="text" id="pAddress" class="song-input ipad-input-fix" placeholder="ƒê·ªãa ch·ªâ"></div></div></div><div class="modal-footer"><button onclick="window.closeModals()" class="flex-1 py-3 btn-glass">H·ªßy</button><button onclick="window.savePatient()" class="flex-1 py-3 btn-primary">L∆∞u H·ªì S∆°</button></div></div></div>

    <!-- NUMBER PAD MODAL -->
    <div id="numberPadModal" class="number-pad-modal"><div class="number-pad-container"><div class="number-pad-header"><h3 id="numberPadTitle" class="font-bold text-lg text-[#3e2723]">Nh·∫≠p s·ªë</h3><p id="numberPadRange" class="text-xs text-gray-500"></p></div><div class="number-pad-display" id="numberPadDisplay">0</div><div class="number-pad-grid"><button class="number-pad-btn" onclick="window.addNumberPadDigit('1')">1</button><button class="number-pad-btn" onclick="window.addNumberPadDigit('2')">2</button><button class="number-pad-btn" onclick="window.addNumberPadDigit('3')">3</button><button class="number-pad-btn" onclick="window.addNumberPadDigit('4')">4</button><button class="number-pad-btn" onclick="window.addNumberPadDigit('5')">5</button><button class="number-pad-btn" onclick="window.addNumberPadDigit('6')">6</button><button class="number-pad-btn" onclick="window.addNumberPadDigit('7')">7</button><button class="number-pad-btn" onclick="window.addNumberPadDigit('8')">8</button><button class="number-pad-btn" onclick="window.addNumberPadDigit('9')">9</button><button class="number-pad-btn clear" onclick="window.clearNumberPad()">C</button><button class="number-pad-btn" onclick="window.addNumberPadDigit('0')">0</button><button class="number-pad-btn delete" onclick="window.deleteNumberPadDigit()">‚å´</button></div><div class="number-pad-footer"><button class="number-pad-close" onclick="window.closeNumberPad()">ƒê√≥ng</button><button class="number-pad-btn confirm" onclick="window.confirmNumberPad()">XONG</button></div></div></div>

    <!-- DISEASE MODAL (L√ÄM L·∫†I CHO TO & ƒê·∫∏P) -->
    <div id="diseaseModal" class="modal">
        <div class="modal-box max-w-2xl max-h-[85vh] overflow-y-auto">
            <div class="modal-header">
                <h2 class="font-bold text-xl text-[#3e2723]" id="diseaseModalTitle">Th√™m B·ªánh M·ªõi</h2>
                <button onclick="window.closeModals()" class="text-3xl text-gray-300 px-2">&times;</button>
            </div>
            <div class="modal-body disease-modal-container">
                <input type="hidden" id="diseaseEditIndex">
                <div class="space-y-4">
                    <div>
                        <label class="song-label">T√™n b·ªánh *</label>
                        <input type="text" id="diseaseName" class="song-input ipad-input-fix" placeholder="Nh·∫≠p t√™n b·ªánh">
                    </div>
                    <div>
                        <label class="song-label">Tri·ªáu ch·ª©ng g·ª£i √Ω</label>
                        <textarea id="diseaseSymptoms" class="song-input ipad-input-fix" rows="2" placeholder="V√≠ d·ª•: s·ªët, ho, ƒëau ƒë·∫ßu"></textarea>
                    </div>
                    
                    <div class="border border-[#d7ccc8] rounded-lg p-4 bg-gray-50">
                        <h3 class="font-bold text-[#5d4037] mb-3">B√†i thu·ªëc ƒê√¥ng Y m·∫´u</h3>
                        <div>
                            <label class="song-label">T√™n b√†i thu·ªëc</label>
                            <input type="text" id="diseaseEastName" class="song-input ipad-input-fix mb-3" placeholder="T√™n b√†i thu·ªëc...">
                        </div>
                        
                        <div id="eastIngredientsContainer" class="space-y-2 mb-3">
                            <!-- Ingredients will be added here dynamically -->
                        </div>
                        
                        <button onclick="window.addEastIngredient()" class="btn-primary text-sm px-4 py-2 w-full">+ Th√™m v·ªã thu·ªëc</button>
                    </div>
                    
                    <div class="border border-blue-200 rounded-lg p-4 bg-blue-50">
                        <h3 class="font-bold text-blue-800 mb-3">Thu·ªëc T√¢y Y m·∫´u</h3>
                        <div id="westMedicinesContainer" class="space-y-2 mb-3">
                            <!-- Medicines will be added here dynamically -->
                        </div>
                        <button onclick="window.addWestMedicine()" class="btn-primary text-sm px-4 py-2 w-full bg-blue-600">+ Th√™m thu·ªëc T√¢y Y</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="window.closeModals()" class="flex-1 py-3 btn-glass">H·ªßy</button>
                <button onclick="window.saveDisease()" class="flex-1 py-3 btn-primary">L∆∞u B·ªánh</button>
            </div>
        </div>
    </div>

    <!-- OTHER MODALS (Backup, Settings, etc.) -->
    <div id="backupModal" class="modal"><div class="modal-box max-w-2xl"><div class="modal-header"><h2 class="font-bold text-xl text-[#3e2723]">üîß Sao l∆∞u & Kh√¥i ph·ª•c</h2><button onclick="window.closeModals()" class="text-3xl text-gray-300 px-2">&times;</button></div><div class="modal-body space-y-6"><div class="backup-grid"><div class="backup-card" onclick="window.exportToExcel()"><div class="backup-icon">üìä</div><div class="backup-title">Xu·∫•t Excel</div><div class="backup-desc">Xu·∫•t d·ªØ li·ªáu b√°o c√°o</div></div><div class="backup-card" onclick="window.exportFullDataExcel()"><div class="backup-icon">üìÅ</div><div class="backup-title">Xu·∫•t to√†n b·ªô Excel</div><div class="backup-desc">Sao l∆∞u to√†n b·ªô d·ªØ li·ªáu</div></div><div class="backup-card" onclick="window.exportToJSON()"><div class="backup-icon">üíæ</div><div class="backup-title">Xu·∫•t JSON</div><div class="backup-desc">Sao l∆∞u file JSON</div></div><div class="backup-card" onclick="window.importFromJSON()"><div class="backup-icon">üîÑ</div><div class="backup-title">Nh·∫≠p JSON</div><div class="backup-desc">Kh√¥i ph·ª•c t·ª´ file backup</div></div></div><div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4"><div class="flex items-center gap-2 mb-2"><span class="text-yellow-600">‚ö†Ô∏è</span><h3 class="font-bold text-yellow-700">L∆∞u √Ω</h3></div><ul class="text-sm text-yellow-600 space-y-1"><li>‚Ä¢ Sao l∆∞u th∆∞·ªùng xuy√™n tr√°nh m·∫•t d·ªØ li·ªáu</li><li>‚Ä¢ Kh√¥i ph·ª•c JSON s·∫Ω ghi ƒë√® d·ªØ li·ªáu hi·ªán t·∫°i</li></ul></div></div><div class="modal-footer"><button onclick="window.closeModals()" class="flex-1 py-3 btn-glass">ƒê√≥ng</button></div></div></div>
    
    <!-- SETTINGS MODAL -->
    <div id="sModal" class="modal">
        <div class="modal-box">
            <div class="modal-header"><h2 class="font-bold text-xl text-[#3e2723]">Thi·∫øt l·∫≠p</h2><button onclick="window.closeModals()" class="text-3xl">&times;</button></div>
            <div class="tabs">
                <button class="tab-btn active" onclick="window.switchSettingsTab('tabUI', this)">Giao di·ªán</button>
                <button class="tab-btn" onclick="window.switchSettingsTab('tabMed', this)">Chuy√™n m√¥n</button>
                <button class="tab-btn" onclick="window.switchSettingsTab('tabSec', this)">B·∫£o m·∫≠t</button>
                <button class="tab-btn" onclick="window.switchSettingsTab('tabBackup', this)">Sao l∆∞u</button>
            </div>
            <div class="modal-body">
                <div id="tabUI" class="settings-panel active space-y-4">
                    <section><label class="song-label">T√™n ph√≤ng kh√°m</label><input type="text" id="confTitle" class="song-input ipad-input-fix"></section>
                    <section><label class="song-label">B√°c sƒ© ph·ª• tr√°ch</label><input type="text" id="confDoctor" class="song-input ipad-input-fix"></section>
                    
                    <div class="p-4 border border-[#d7ccc8] rounded-xl bg-gray-50 space-y-4">
                        <h3 class="font-bold text-[#5d4037] border-b border-gray-300 pb-2 mb-2">üé® T√πy ch·ªânh Giao di·ªán</h3>
                        
                        <div>
                            <label class="song-label">H√¨nh n·ªÅn Ti√™u ƒë·ªÅ (Header)</label>
                            <input type="file" id="headerBgInput" accept="image/*" class="text-sm w-full mb-2" onchange="window.handleImageUpload(this, 'headerBgImage', null, true)">
                            <div class="flex justify-between items-center">
                                <label class="text-xs font-bold text-gray-500">ƒê·ªô t·ªëi n·ªÅn (ƒê·ªÉ ch·ªØ tr·∫Øng n·ªïi h∆°n)</label>
                                <span id="overlayValueDisplay" class="text-xs font-bold">0%</span>
                            </div>
                            <input type="range" id="headerOverlayInput" min="0" max="80" value="0" class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer accent-[#5d4037]" oninput="window.updateHeaderOverlay(this.value)">
                            <button onclick="window.clearHeaderImage()" class="text-xs text-red-600 underline mt-1">X√≥a h√¨nh n·ªÅn</button>
                        </div>

                        <div>
                            <label class="song-label">M√£ QR Ng√¢n h√†ng (Cho h√≥a ƒë∆°n)</label>
                            <div class="flex gap-4 items-start">
                                <div class="flex-1">
                                    <input type="file" id="qrInput" accept="image/*" class="text-sm w-full" onchange="window.handleImageUpload(this, 'qrCodeImage', 'previewQrSettings')">
                                    <button onclick="window.clearQrImage()" class="text-xs text-red-600 underline mt-2">X√≥a m√£ QR</button>
                                </div>
                                <div class="w-20 h-20 border bg-white flex items-center justify-center rounded overflow-hidden">
                                    <img id="previewQrSettings" src="" class="w-full h-full object-contain" alt="QR">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- C·∫¨P NH·∫¨T PH·∫¶N C·∫§U H√åNH T·ª® CH·∫®N M·ªöI -->
                <div id="tabMed" class="settings-panel space-y-6 hidden">
                    <div>
                        <h3 class="font-bold text-[#3e2723] mb-2 uppercase border-b pb-1 text-sm">Danh m·ª•c B·ªánh</h3>
                        <div id="diseaseList" class="space-y-2 mb-3"></div>
                        <button onclick="window.addNewDisease()" class="w-full py-3 border border-dashed border-[#bdbdbd] font-bold rounded-xl text-gray-500 hover:bg-gray-50 active:bg-gray-100">+ Th√™m B·ªánh M·ªõi</button>
                    </div>
                    <div>
                        <h3 class="font-bold text-[#3e2723] mb-2 uppercase border-b pb-1 text-sm">D·ªãch v·ª• Th·ªß thu·∫≠t</h3>
                        <div id="procList" class="space-y-2 mb-3"></div>
                        <div class="flex gap-2">
                            <input type="text" id="newProcName" placeholder="T√™n DV" class="song-input flex-1 ipad-input-fix">
                            <input type="number" id="newProcPrice" placeholder="Gi√° 1 l·∫ßn" class="song-input w-24 ipad-input-fix">
                            <button onclick="window.addProc()" class="btn-primary px-4 text-sm">Th√™m</button>
                        </div>
                    </div>
                    
                    <!-- KHU V·ª∞C C·∫§U H√åNH T·ª® CH·∫®N ƒê√É ƒê∆Ø·ª¢C C·∫¨P NH·∫¨T ID ƒê·ªÇ KH·ªöP SCRIPT -->
                    <div>
                        <h3 class="font-bold text-[#3e2723] mb-2 uppercase border-b pb-1 text-sm">C·∫•u h√¨nh T·ª© ch·∫©n</h3>
                        <div id="tuChanConfigArea" class="space-y-4">
                            <!-- V·ªåNG -->
                            <div class="p-3 border rounded bg-white">
                                <h4 class="font-bold text-sm mb-2 text-[#5d4037] uppercase">V·ªçng (Nh√¨n)</h4>
                                <div id="setting_list_vong" class="mb-3 space-y-1 max-h-40 overflow-y-auto"></div>
                                <div class="flex gap-2">
                                    <input type="text" id="setting_new_vong" placeholder="Th√™m tri·ªáu ch·ª©ng..." class="song-input text-sm flex-1 ipad-input-fix">
                                    <button onclick="window.addTuChanItem('vong')" class="btn-primary text-xs px-3 py-1 bg-[#5d4037]">+ Th√™m</button>
                                </div>
                            </div>

                            <!-- VƒÇN -->
                            <div class="p-3 border rounded bg-white">
                                <h4 class="font-bold text-sm mb-2 text-[#5d4037] uppercase">VƒÉn (Nghe/Ng·ª≠i)</h4>
                                <div id="setting_list_van" class="mb-3 space-y-1 max-h-40 overflow-y-auto"></div>
                                <div class="flex gap-2">
                                    <input type="text" id="setting_new_van" placeholder="Th√™m tri·ªáu ch·ª©ng..." class="song-input text-sm flex-1 ipad-input-fix">
                                    <button onclick="window.addTuChanItem('van')" class="btn-primary text-xs px-3 py-1 bg-[#5d4037]">+ Th√™m</button>
                                </div>
                            </div>

                            <!-- V·∫§N -->
                            <div class="p-3 border rounded bg-white">
                                <h4 class="font-bold text-sm mb-2 text-[#5d4037] uppercase">V·∫•n (H·ªèi)</h4>
                                <div id="setting_list_vanhoi" class="mb-3 space-y-1 max-h-40 overflow-y-auto"></div>
                                <div class="flex gap-2">
                                    <input type="text" id="setting_new_vanhoi" placeholder="Th√™m tri·ªáu ch·ª©ng..." class="song-input text-sm flex-1 ipad-input-fix">
                                    <button onclick="window.addTuChanItem('vanhoi')" class="btn-primary text-xs px-3 py-1 bg-[#5d4037]">+ Th√™m</button>
                                </div>
                            </div>

                            <!-- THI·∫æT -->
                            <div class="p-3 border rounded bg-white">
                                <h4 class="font-bold text-sm mb-2 text-[#5d4037] uppercase">Thi·∫øt (S·ªù n·∫Øn)</h4>
                                <div id="setting_list_thiet" class="mb-3 space-y-1 max-h-40 overflow-y-auto"></div>
                                <div class="flex gap-2">
                                    <input type="text" id="setting_new_thiet" placeholder="Th√™m tri·ªáu ch·ª©ng..." class="song-input text-sm flex-1 ipad-input-fix">
                                    <button onclick="window.addTuChanItem('thiet')" class="btn-primary text-xs px-3 py-1 bg-[#5d4037]">+ Th√™m</button>
                                </div>
                            </div>

                            <!-- THI·ªÜT -->
                            <div class="p-3 border rounded bg-white">
                                <h4 class="font-bold text-sm mb-2 text-[#5d4037] uppercase">Thi·ªát (L∆∞·ª°i)</h4>
                                <div id="setting_list_thietchan" class="mb-3 space-y-1 max-h-40 overflow-y-auto"></div>
                                <div class="flex gap-2">
                                    <input type="text" id="setting_new_thietchan" placeholder="Th√™m tri·ªáu ch·ª©ng..." class="song-input text-sm flex-1 ipad-input-fix">
                                    <button onclick="window.addTuChanItem('thietchan')" class="btn-primary text-xs px-3 py-1 bg-[#5d4037]">+ Th√™m</button>
                                </div>
                            </div>

                            <!-- M·∫†CH -->
                            <div class="p-3 border rounded bg-white">
                                <h4 class="font-bold text-sm mb-2 text-[#5d4037] uppercase">M·∫°ch ch·∫©n</h4>
                                <div id="setting_list_machchan" class="mb-3 space-y-1 max-h-40 overflow-y-auto"></div>
                                <div class="flex gap-2">
                                    <input type="text" id="setting_new_machchan" placeholder="Th√™m tri·ªáu ch·ª©ng..." class="song-input text-sm flex-1 ipad-input-fix">
                                    <button onclick="window.addTuChanItem('machchan')" class="btn-primary text-xs px-3 py-1 bg-[#5d4037]">+ Th√™m</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tabSec" class="settings-panel space-y-4 hidden"><section><label class="song-label">M·∫≠t kh·∫©u admin</label><div class="flex gap-2"><input type="password" id="confPass" readonly class="song-input w-32 bg-[#f5f5f5] text-center"><button onclick="window.openKeypad('settings')" class="btn-primary px-4 text-xs">ƒê·ªïi pass</button></div></section></div>
                <div id="tabBackup" class="settings-panel space-y-4 hidden"><div class="text-center"><button onclick="window.openBackupModalDirect()" class="btn-primary px-6 py-3 text-lg">üìÇ M·ªü c√¥ng c·ª• Sao l∆∞u</button><p class="text-sm text-gray-500 mt-2">Xu·∫•t/nh·∫≠p d·ªØ li·ªáu</p></div></div>
            </div>
            <div class="modal-footer justify-end"><button onclick="window.saveSettings()" class="btn-primary px-6">L∆∞u C·∫•u H√¨nh</button></div>
        </div>
    </div>

    <!-- ANALYTICS MODAL (C·∫¨P NH·∫¨T: TH√äM C·ªòT TU·ªîI, TT V√Ä SORT) -->
    <div id="analyticsModal" class="modal">
        <div class="modal-box max-w-5xl">
            <div class="modal-header">
                <h2 class="font-bold text-xl uppercase">Th·ªëng K√™ & B√°o C√°o</h2>
                <button onclick="window.closeModals()" class="text-2xl">&times;</button>
            </div>
            <div class="modal-body">
                <div class="flex flex-wrap gap-2 mb-4">
                    <!-- Time Filter -->
                    <select id="anaTimeFilter" onchange="window.renderAnalytics()" class="song-input w-32">
                        <option value="today">H√¥m nay</option>
                        <option value="month" selected>Th√°ng n√†y</option>
                        <option value="all">T·∫•t c·∫£</option>
                    </select>
                    
                    <!-- NEW SORT FILTER -->
                    <select id="anaSortBy" onchange="window.renderAnalytics()" class="song-input w-40">
                        <option value="date_desc">üìÖ M·ªõi nh·∫•t</option>
                        <option value="name_asc">üî§ T√™n A-Z</option>
                        <option value="age_asc">üë∂ Tu·ªïi (TƒÉng)</option>
                        <option value="visits_desc">üîÑ S·ªë l·∫ßn kh√°m</option>
                        <option value="total_desc">üí∞ T·ªïng chi ti√™u</option>
                    </select>

                    <button onclick="window.exportToExcel()" class="btn-glass text-green-700 border-green-200 px-4">üìä Xu·∫•t Excel</button>
                    <button onclick="window.openBackupModalDirect()" class="btn-primary px-4">üíæ Sao l∆∞u</button>
                </div>
                
                <div class="h-64 mb-4 border rounded-xl p-2">
                    <canvas id="analyticsChart"></canvas>
                </div>
                
                <!-- TABLE WITH NEW COLUMNS -->
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-gray-50 text-left text-xs uppercase text-gray-500">
                            <th class="p-2">Ng√†y</th>
                            <th class="p-2">T√™n</th>
                            <th class="p-2">Tu·ªïi</th> <!-- NEW -->
                            <th class="p-2">B·ªánh</th>
                            <th class="p-2 text-center">TT</th> <!-- NEW: Paid status -->
                            <th class="p-2 text-right">Thu</th>
                            <th class="p-2 text-right">L√£i</th>
                        </tr>
                    </thead>
                    <tbody id="anaTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- OTHER MODALS (History) -->
    <div id="hModal" class="modal"><div class="modal-box max-w-2xl"><div class="modal-header"><h2 class="font-bold text-xl serif">L·ªãch s·ª≠: <span id="hName"></span></h2><button onclick="window.closeModals()" class="text-3xl">&times;</button></div><div id="hContent" class="modal-body space-y-3"></div></div></div>

    <input type="file" id="jsonFileInput" accept=".json" style="display:none" onchange="window.handleJSONFileSelect(event)">

    <script src="script.js"></script>
</body>
</html>


